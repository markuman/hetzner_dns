---
- hosts: localhost
  connection: local
  gather_facts: no

  vars:
    TEST_ZONE: osuv.de

  tasks:
    - name: test create
      block:
        - name: test gracefull error handling
          markuman.hetzner_dns.record:
            zone_name: none_existing
            name: hetzner_dns_ansible_collection
            value: osuv.de.
            type: CNAME
            ttl: 300
          register: RECORD
          ignore_errors: yes

        - name: verify graceful error handling
          assert:
            that:
              - RECORD is not changed
              - RECORD is failed
              - 'RECORD.msg == "zone or zone_id: Not found."'

        - name: fetch zone info
          markuman.hetzner_dns.zone_info:
            name: "{{ TEST_ZONE }}"
          register: ZONES

        - name: >
            fetch zone info must also work
            in check_mode
          markuman.hetzner_dns.zone_info:
            name: "{{ TEST_ZONE }}"
          check_mode: yes
          register: ZONES

        - name: add record
          markuman.hetzner_dns.record:
            zone_id: "{{ ZONES.zone_id }}"
            name: hetzner_dns_ansible_collection
            value: osuv.de.
            type: CNAME
            ttl: 300
          register: RECORD

        - name: assert add record
          assert:
            that:
              - RECORD is changed
              - RECORD.record_info.record.ttl == 300

        - name: fetch record info
          markuman.hetzner_dns.record_info:
            filter:
              - name: hetzner_dns_ansible_collection
                type: CNAME
            zone_name: "{{ TEST_ZONE }}"

        - name: >
            fetch record info must
            also work in check_mode
          markuman.hetzner_dns.record_info:
            filter:
              - name: hetzner_dns_ansible_collection
                type: CNAME
            zone_name: "{{ TEST_ZONE }}"
          check_mode: yes

        - name: add record no change
          markuman.hetzner_dns.record:
            zone_name: "{{ TEST_ZONE }}"
            name: hetzner_dns_ansible_collection
            value: osuv.de.
            type: CNAME
            ttl: 300
          register: RECORD
        
        - name: assert add record no change
          assert:
            that:
              - RECORD is not changed
              - RECORD.past_record.ttl == 300
              - RECORD.record_info.record.ttl == 300

        - name: modify record change in check_mode
          markuman.hetzner_dns.record:
            zone_name: "{{ TEST_ZONE }}"
            name: hetzner_dns_ansible_collection
            value: osuv.de.
            type: CNAME
            ttl: 60
          check_mode: yes
          register: RECORD

        - name: assert change record check_mode
          assert:
            that:
              - RECORD is changed
              - RECORD.record_info.record.ttl == 60
              - RECORD.past_record.ttl == 300

        - name: modify record change
          markuman.hetzner_dns.record:
            zone_name: "{{ TEST_ZONE }}"
            name: hetzner_dns_ansible_collection
            value: osuv.de.
            type: CNAME
            ttl: 60
          register: RECORD

        - name: assert change record
          assert:
            that:
              - RECORD is changed
              - RECORD.record_info.record.ttl == 60
              - RECORD.past_record.ttl == 300

        - name: del record
          markuman.hetzner_dns.record:
            zone_name: "{{ TEST_ZONE }}"
            name: hetzner_dns_ansible_collection
            type: CNAME
            state: absent
          register: RECORD

        - name: assert del record
          assert:
            that:
              - RECORD is changed

        - name: del record no change
          markuman.hetzner_dns.record:
            zone_name: "{{ TEST_ZONE }}"
            name: hetzner_dns_ansible_collection
            type: CNAME
            state: absent
          register: RECORD

        - name: assert del record
          assert:
            that:
              - RECORD is not changed

      always:
        - name: always del record
          markuman.hetzner_dns.record:
            zone_name: "{{ TEST_ZONE }}"
            name: hetzner_dns_ansible_collection
            type: CNAME
            state: absent
